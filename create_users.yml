---
################################################################################
# Playbook: create_users.yml
# Description: Automatisation de la crÃ©ation d'utilisateurs avec Ansible
# Auteur: Ã‰tudiant Licence 3 Informatique - UY1
# Cours: INF 3611 - Administration SystÃ¨mes et RÃ©seaux
################################################################################

- name: CrÃ©ation automatisÃ©e d'utilisateurs Linux avec envoi d'emails
  hosts: vps_servers
  become: yes
  gather_facts: yes
  
  vars:
    # Variables principales
    group_name: "students-inf-361"
    users_file: "../users.txt"
    disk_quota_gb: 15
    memory_limit_percent: 20
    
    # Configuration SSH du serveur
    ssh_port: 22  # Modifier selon votre configuration
    
    # Configuration email
    smtp_host: "smtp.gmail.com"
    smtp_port: 587
    smtp_username: "votre-email@gmail.com"  # Ã€ MODIFIER
    smtp_password: "votre-mot-de-passe-app"  # Ã€ MODIFIER (App Password recommandÃ©)
    email_from: "admin@uy1.cm"
    
    # Liste des utilisateurs (sera remplie depuis le fichier)
    users_list: []

  tasks:
    # ========================================================================
    # PHASE 0: PRÃ‰PARATION
    # ========================================================================
    
    - name: 0.1 - Afficher un message de dÃ©but
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      ANSIBLE - CRÃ‰ATION AUTOMATISÃ‰E D'UTILISATEURS            â•‘
          â•‘                 UNIVERSITÃ‰ DE YAOUNDÃ‰ I                        â•‘
          â•‘          INF 3611 - Administration SystÃ¨mes et RÃ©seaux         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Serveur cible: {{ inventory_hostname }}
          Groupe: {{ group_name }}
          Fichier source: {{ users_file }}

    - name: 0.2 - Installer les dÃ©pendances systÃ¨me
      apt:
        name:
          - python3-pip
          - quota
          - quotatool
          - libpam-modules
          - zsh
          - fish
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: 0.3 - Installer les bibliothÃ¨ques Python pour l'envoi d'emails
      pip:
        name:
          - jinja2
        state: present

    # ========================================================================
    # PHASE 1: LECTURE ET PARSING DU FICHIER UTILISATEURS
    # ========================================================================

    - name: 1.1 - VÃ©rifier l'existence du fichier utilisateurs
      stat:
        path: "{{ users_file }}"
      delegate_to: localhost
      register: users_file_stat
      become: no

    - name: 1.2 - Ã‰chec si le fichier n'existe pas
      fail:
        msg: "Le fichier {{ users_file }} n'existe pas!"
      when: not users_file_stat.stat.exists

    - name: 1.3 - Lire le fichier utilisateurs
      slurp:
        src: "{{ users_file }}"
      delegate_to: localhost
      become: no
      register: users_file_content

    - name: 1.4 - Parser le contenu du fichier
      set_fact:
        users_list: "{{ users_list + [item | combine({'password_hash': item.password | password_hash('sha512')}) ] }}"
      loop: "{{ (users_file_content.content | b64decode).split('\n') | select('match', '^[^#].*') | select('match', '.*;.*;.*;.*;.*;.*') | map('regex_replace', '\\s+', '') | list }}"
      vars:
        item: >-
          {{
            {
              'username': line_parts[0],
              'password': line_parts[1],
              'full_name': line_parts[2],
              'phone': line_parts[3],
              'email': line_parts[4],
              'shell': line_parts[5]
            }
          }}
        line_parts: "{{ item.split(';') }}"
      when: item | length > 0

    - name: 1.5 - Afficher le nombre d'utilisateurs Ã  crÃ©er
      debug:
        msg: "{{ users_list | length }} utilisateur(s) Ã  crÃ©er"

    # ========================================================================
    # PHASE 2: CRÃ‰ATION DU GROUPE PRINCIPAL
    # ========================================================================

    - name: 2.1 - CrÃ©er le groupe principal
      group:
        name: "{{ group_name }}"
        state: present
      register: group_creation

    - name: 2.2 - Afficher le rÃ©sultat de la crÃ©ation du groupe
      debug:
        msg: "âœ“ Groupe {{ group_name }} {{ 'crÃ©Ã©' if group_creation.changed else 'existe dÃ©jÃ ' }}"

    # ========================================================================
    # PHASE 3: CONFIGURATION SUDO AVEC RESTRICTION SU
    # ========================================================================

    - name: 3.1 - CrÃ©er la configuration sudoers pour le groupe
      template:
        dest: "/etc/sudoers.d/{{ group_name }}"
        mode: '0440'
        content: |
          # Configuration sudo pour le groupe {{ group_name }}
          # Membres peuvent utiliser sudo mais pas la commande su
          %{{ group_name }} ALL=(ALL:ALL) ALL, !/bin/su, !/usr/bin/su
        validate: 'visudo -cf %s'

    - name: 3.2 - Confirmation de la configuration sudo
      debug:
        msg: "âœ“ Restrictions sudo configurÃ©es (su dÃ©sactivÃ©)"

    # ========================================================================
    # PHASE 4: ACTIVATION DES QUOTAS DISQUE
    # ========================================================================

    - name: 4.1 - VÃ©rifier si les quotas sont activÃ©s sur /home
      shell: quotaon -p /home 2>&1 | grep -q "on" && echo "enabled" || echo "disabled"
      register: quota_status
      changed_when: false
      failed_when: false

    - name: 4.2 - Activer les quotas si nÃ©cessaire
      block:
        - name: 4.2.1 - CrÃ©er les fichiers de quotas
          command: quotacheck -cugm /home
          args:
            creates: /home/aquota.user
          ignore_errors: yes

        - name: 4.2.2 - Activer les quotas
          command: quotaon /home
          when: quota_status.stdout == "disabled"
          ignore_errors: yes
      when: quota_status.stdout == "disabled"

    # ========================================================================
    # PHASE 5: CRÃ‰ATION DES UTILISATEURS
    # ========================================================================

    - name: 5.1 - CrÃ©er les utilisateurs
      user:
        name: "{{ item.username }}"
        comment: "{{ item.full_name }},{{ item.phone }},{{ item.email }}"
        shell: "{{ item.shell }}"
        groups: "{{ group_name }},sudo"
        append: yes
        create_home: yes
        state: present
        password: "{{ item.password_hash }}"
      loop: "{{ users_list }}"
      register: users_created

    - name: 5.2 - Forcer le changement de mot de passe Ã  la premiÃ¨re connexion
      command: "chage -d 0 {{ item.username }}"
      loop: "{{ users_list }}"
      when: users_created is changed

    - name: 5.3 - Afficher la progression
      debug:
        msg: "âœ“ Utilisateur {{ item.username }} crÃ©Ã© avec succÃ¨s"
      loop: "{{ users_list }}"

    # ========================================================================
    # PHASE 6: CONFIGURATION DES QUOTAS DISQUE PAR UTILISATEUR
    # ========================================================================

    - name: 6.1 - Configurer les quotas disque (15 Go)
      command: >
        setquota -u {{ item.username }} 
        {{ disk_quota_gb * 1024 * 1024 }} 
        {{ disk_quota_gb * 1024 * 1024 }} 
        0 0 /home
      loop: "{{ users_list }}"
      ignore_errors: yes

    - name: 6.2 - Confirmation des quotas
      debug:
        msg: "âœ“ Quotas de {{ disk_quota_gb }}Go configurÃ©s pour tous les utilisateurs"

    # ========================================================================
    # PHASE 7: CONFIGURATION DES LIMITES MÃ‰MOIRE
    # ========================================================================

    - name: 7.1 - Calculer la limite mÃ©moire (20% de la RAM)
      set_fact:
        memory_limit_kb: "{{ (ansible_memtotal_mb * 1024 * memory_limit_percent / 100) | int }}"

    - name: 7.2 - CrÃ©er les fichiers de limites pour chaque utilisateur
      template:
        dest: "/etc/security/limits.d/{{ item.username }}.conf"
        mode: '0644'
        content: |
          # Limites de ressources pour {{ item.username }}
          # 20% de la RAM totale ({{ memory_limit_kb }} KB)
          {{ item.username }} soft rss {{ memory_limit_kb }}
          {{ item.username }} hard rss {{ memory_limit_kb }}
          {{ item.username }} soft nproc 100
          {{ item.username }} hard nproc 150
      loop: "{{ users_list }}"

    - name: 7.3 - Confirmation des limites mÃ©moire
      debug:
        msg: "âœ“ Limites mÃ©moire configurÃ©es: {{ memory_limit_kb }}KB ({{ memory_limit_percent }}% RAM)"

    # ========================================================================
    # PHASE 8: CRÃ‰ATION DU MESSAGE DE BIENVENUE
    # ========================================================================

    - name: 8.1 - CrÃ©er le fichier de bienvenue pour chaque utilisateur
      template:
        dest: "/home/{{ item.username }}/WELCOME.txt"
        owner: "{{ item.username }}"
        group: "{{ item.username }}"
        mode: '0644'
        content: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    BIENVENUE SUR LE SERVEUR VPS                â•‘
          â•‘                  UNIVERSITÃ‰ DE YAOUNDÃ‰ I                       â•‘
          â•‘            DÃ©partement d'Informatique - Licence 3              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Bonjour {{ item.full_name }} ({{ item.username }}),
          
          Vous Ãªtes maintenant connectÃ©(e) au serveur VPS du cours INF 3611.
          
          ğŸ“‹ INFORMATIONS IMPORTANTES :
             â€¢ Groupe : {{ group_name }}
             â€¢ Quota disque : {{ disk_quota_gb }} Go maximum
             â€¢ Limite mÃ©moire : {{ memory_limit_percent }}% de la RAM par processus
             â€¢ Vous devez changer votre mot de passe Ã  la premiÃ¨re connexion
          
          âš ï¸  RÃˆGLES DE SÃ‰CURITÃ‰ :
             â€¢ Ne partagez jamais vos identifiants
             â€¢ Utilisez des mots de passe forts
             â€¢ La commande 'su' est dÃ©sactivÃ©e pour votre sÃ©curitÃ©
             â€¢ Toutes vos actions sont journalisÃ©es
          
          ğŸ“ SUPPORT :
             â€¢ En cas de problÃ¨me, contactez l'administrateur systÃ¨me
             â€¢ Email : admin@uy1.cm
          
          Bon travail ! ğŸš€
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Date de crÃ©ation du compte : {{ ansible_date_time.date }} Ã  {{ ansible_date_time.time }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      loop: "{{ users_list }}"

    - name: 8.2 - Configurer .bashrc pour afficher le message
      lineinfile:
        path: "/home/{{ item.username }}/.bashrc"
        line: |
          # Affichage du message de bienvenue
          if [ -f ~/WELCOME.txt ]; then
              cat ~/WELCOME.txt
          fi
        create: yes
        owner: "{{ item.username }}"
        group: "{{ item.username }}"
        mode: '0644'
      loop: "{{ users_list }}"

    - name: 8.3 - Confirmation des messages de bienvenue
      debug:
        msg: "âœ“ Messages de bienvenue crÃ©Ã©s et configurÃ©s"

    # ========================================================================
    # PHASE 9: ENVOI DES EMAILS DE NOTIFICATION
    # ========================================================================

    - name: 9.1 - RÃ©cupÃ©rer l'adresse IP du serveur
      set_fact:
        server_ip: "{{ ansible_default_ipv4.address }}"

    - name: 9.2 - Envoyer un email personnalisÃ© Ã  chaque utilisateur
      mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_username }}"
        password: "{{ smtp_password }}"
        to: "{{ item.email }}"
        from: "{{ email_from }}"
        subject: "Votre compte VPS a Ã©tÃ© crÃ©Ã© - Cours INF 3611"
        body: |
          Bonjour {{ item.full_name }},
          
          Votre compte utilisateur a Ã©tÃ© crÃ©Ã© avec succÃ¨s sur le serveur VPS du cours INF 3611.
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“‹ INFORMATIONS DE CONNEXION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ–¥ï¸  Adresse IP du serveur : {{ server_ip }}
          ğŸ”Œ Port SSH              : {{ ssh_port }}
          ğŸ‘¤ Nom d'utilisateur     : {{ item.username }}
          ğŸ” Mot de passe initial  : {{ item.password }}
          
          âš ï¸  IMPORTANT : Vous DEVEZ changer ce mot de passe lors de votre premiÃ¨re connexion.
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ”§ COMMANDES UTILES
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“¡ Commande de connexion SSH :
          
             ssh -p {{ ssh_port }} {{ item.username }}@{{ server_ip }}
          
          ğŸ”‘ TransfÃ©rer votre clÃ© publique SSH (recommandÃ©) :
          
             - Depuis Linux/Mac :
               ssh-copy-id -p {{ ssh_port }} {{ item.username }}@{{ server_ip }}
          
             - Depuis Windows (PowerShell) :
               type $env:USERPROFILE\.ssh\id_rsa.pub | ssh -p {{ ssh_port }} {{ item.username }}@{{ server_ip }} "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
          
             - Alternative multiplateforme :
               cat ~/.ssh/id_rsa.pub | ssh -p {{ ssh_port }} {{ item.username }}@{{ server_ip }} "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â„¹ï¸  INFORMATIONS DU COMPTE
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          â€¢ Groupe                : {{ group_name }}
          â€¢ Shell                 : {{ item.shell }}
          â€¢ Quota disque          : {{ disk_quota_gb }} Go maximum
          â€¢ Limite mÃ©moire        : {{ memory_limit_percent }}% de la RAM par processus
          â€¢ RÃ©pertoire personnel  : /home/{{ item.username }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ›¡ï¸  RÃˆGLES DE SÃ‰CURITÃ‰
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          1. Changez immÃ©diatement votre mot de passe initial
          2. Utilisez un mot de passe fort (12+ caractÃ¨res, majuscules, minuscules, chiffres, symboles)
          3. Ne partagez JAMAIS vos identifiants
          4. Configurez l'authentification par clÃ©s SSH (voir commandes ci-dessus)
          5. La commande 'su' est dÃ©sactivÃ©e pour votre sÃ©curitÃ©
          6. Toutes vos actions sont journalisÃ©es
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“ SUPPORT
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          En cas de problÃ¨me, contactez :
          â€¢ Email : admin@uy1.cm
          â€¢ TÃ©lÃ©phone : {{ item.phone }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Bon travail et bienvenue sur le serveur ! ğŸš€
          
          ---
          UniversitÃ© de YaoundÃ© I
          DÃ©partement d'Informatique
          INF 3611 - Administration SystÃ¨mes et RÃ©seaux
          
          Ce message a Ã©tÃ© gÃ©nÃ©rÃ© automatiquement le {{ ansible_date_time.date }} Ã  {{ ansible_date_time.time }}.
        charset: utf8
        subtype: plain
      loop: "{{ users_list }}"
      ignore_errors: yes  # Continuer mÃªme si l'envoi Ã©choue
      register: email_results

    - name: 9.3 - Afficher le statut des emails
      debug:
        msg: "{{ 'âœ“ Email envoyÃ©' if not item.failed else 'âœ— Ã‰chec envoi email' }} Ã  {{ item.item.email }}"
      loop: "{{ email_results.results }}"
      loop_control:
        label: "{{ item.item.username }}"

    # ========================================================================
    # PHASE 10: RÃ‰SUMÃ‰ FINAL
    # ========================================================================

    - name: 10.1 - Afficher le rÃ©sumÃ© final
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… CRÃ‰ATION D'UTILISATEURS TERMINÃ‰E AVEC SUCCÃˆS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Statistiques :
             â€¢ Utilisateurs crÃ©Ã©s   : {{ users_list | length }}
             â€¢ Groupe principal     : {{ group_name }}
             â€¢ Quota disque         : {{ disk_quota_gb }} Go
             â€¢ Limite mÃ©moire       : {{ memory_limit_percent }}% RAM
             â€¢ Serveur              : {{ inventory_hostname }} ({{ server_ip }})
             â€¢ Port SSH             : {{ ssh_port }}
          
          âœ… FonctionnalitÃ©s configurÃ©es :
             âœ“ Comptes utilisateurs crÃ©Ã©s
             âœ“ Mots de passe hachÃ©s (SHA-512)
             âœ“ Changement de mot de passe obligatoire
             âœ“ AccÃ¨s sudo avec restriction 'su'
             âœ“ Messages de bienvenue personnalisÃ©s
             âœ“ Quotas disque configurÃ©s
             âœ“ Limites mÃ©moire actives
             âœ“ Emails de notification envoyÃ©s
          
          ğŸ’¡ Commandes utiles :
             â€¢ Lister le groupe    : getent group {{ group_name }}
             â€¢ VÃ©rifier un quota   : sudo quota -u USERNAME
             â€¢ Tester connexion    : ssh -p {{ ssh_port }} USERNAME@{{ server_ip }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•