Partie 3 : Infrastructure as Code avec Terraform
üìã Description
Configuration Terraform pour d√©ployer et ex√©cuter automatiquement le script de cr√©ation d'utilisateurs sur un serveur VPS. Cette approche permet de g√©rer l'infrastructure comme du code (IaC) avec versioning, reproductibilit√© et automatisation compl√®te.

üéØ Objectifs
Infrastructure as Code : Gestion d√©clarative du d√©ploiement
Automatisation compl√®te : Upload et ex√©cution du script Bash
Reproductibilit√© : D√©ploiement identique √† chaque ex√©cution
√âtat g√©r√© : Terraform track l'√©tat de l'infrastructure
Idempotence : R√©ex√©cution s√ªre et pr√©visible
üì¶ Structure des fichiers
partie-3-terraform/
‚îú‚îÄ‚îÄ README.md                     # Ce fichier
‚îú‚îÄ‚îÄ main.tf                       # Configuration principale
‚îú‚îÄ‚îÄ variables.tf                  # D√©finition des variables
‚îú‚îÄ‚îÄ outputs.tf                    # Sorties et informations
‚îú‚îÄ‚îÄ terraform.tfvars.example      # Exemple de configuration
‚îú‚îÄ‚îÄ terraform.tfvars             # Configuration r√©elle (√† cr√©er, non commit√©)
‚îú‚îÄ‚îÄ .terraform/                   # R√©pertoire Terraform (auto-g√©n√©r√©)
‚îú‚îÄ‚îÄ terraform.tfstate            # √âtat Terraform (auto-g√©n√©r√©)
‚îî‚îÄ‚îÄ terraform_logs/              # Logs r√©cup√©r√©s (auto-cr√©√©)
üîß Pr√©requis
Installation de Terraform
bash
# Ubuntu/Debian
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform

# V√©rifier l'installation
terraform version
Autres pr√©requis
Acc√®s SSH au serveur cible (cl√© priv√©e configur√©e)
Script create_users.sh fonctionnel (Partie 1)
Fichier users.txt pr√©par√©
‚öôÔ∏è Configuration
1. Cr√©er le fichier de configuration
bash
# Copier l'exemple
cp terraform.tfvars.example terraform.tfvars

# √âditer avec vos valeurs
nano terraform.tfvars
2. Configuration minimale requise
terraform.tfvars :

hcl
# OBLIGATOIRE: Remplacer par vos vraies valeurs
server_ip                = "51.15.123.45"
ssh_user                 = "root"
ssh_private_key_path     = "~/.ssh/id_rsa"
ssh_port                 = 22

# Chemins vers les fichiers
script_path              = "../partie-1-bash/create_users.sh"
users_file_path          = "../users.txt"

# Configuration
group_name               = "students-inf-361"
3. V√©rifier les chemins
bash
# V√©rifier que le script existe
ls -lh ../partie-1-bash/create_users.sh

# V√©rifier que le fichier utilisateurs existe
ls -lh ../users.txt

# V√©rifier que la cl√© SSH existe
ls -lh ~/.ssh/id_rsa

# Tester la connexion SSH
ssh -p 22 -i ~/.ssh/id_rsa root@51.15.123.45 'echo "Connection OK"'
üöÄ Utilisation
Workflow Terraform standard
bash
# 1. Initialiser Terraform (premi√®re fois uniquement)
terraform init

# 2. Valider la configuration
terraform validate

# 3. Formatter le code (optionnel)
terraform fmt

# 4. Pr√©visualiser les changements
terraform plan

# 5. Appliquer la configuration
terraform apply

# 6. Confirmer avec 'yes' quand demand√©
Commandes d√©taill√©es
1. Initialisation
bash
terraform init

# Sortie attendue:
# Initializing the backend...
# Initializing provider plugins...
# - Finding hashicorp/null versions matching "~> 3.0"...
# - Installing hashicorp/null v3.x.x...
# Terraform has been successfully initialized!
2. Planification
bash
# Plan avec sortie d√©taill√©e
terraform plan

# Sauvegarder le plan
terraform plan -out=tfplan

# Plan avec variables sp√©cifiques
terraform plan -var="server_ip=192.168.1.100"
3. Application
bash
# Application standard
terraform apply

# Application automatique (sans confirmation)
terraform apply -auto-approve

# Application d'un plan sauvegard√©
terraform apply tfplan

# Application avec variables en ligne
terraform apply -var="server_ip=192.168.1.100" -var="ssh_port=2222"
4. V√©rification
bash
# Voir l'√©tat actuel
terraform show

# Lister les ressources
terraform state list

# Voir les outputs
terraform output

# Voir un output sp√©cifique
terraform output server_connection_info
terraform output useful_commands
5. Destruction (si n√©cessaire)
bash
# D√©truire l'infrastructure (ne supprime PAS les utilisateurs cr√©√©s)
terraform destroy

# Destruction automatique
terraform destroy -auto-approve
üìä Sorties (Outputs)
Apr√®s une ex√©cution r√©ussie, Terraform affiche :

hcl
Outputs:

deployment_summary = {
  "group_name" = "students-inf-361"
  "script_executed" = true
  "server_ip" = "51.15.123.45"
  "ssh_port" = 22
  "timestamp" = "2025-12-15T14:30:00Z"
}

server_connection_info = {
  "ip_address" = "51.15.123.45"
  "ssh_command" = "ssh -p 22 root@51.15.123.45"
  "ssh_port" = 22
  "ssh_user" = "root"
}

useful_commands = {
  "connect_to_server" = "ssh -p 22 root@51.15.123.45"
  "download_latest_log" = "scp -P 22 root@51.15.123.45:/tmp/logs/user_creation_*.log ."
  "list_group_users" = "ssh -p 22 root@51.15.123.45 'getent group students-inf-361'"
  "test_user_connection" = "ssh -p 22 USERNAME@51.15.123.45"
  "view_remote_logs" = "ssh -p 22 root@51.15.123.45 'ls -lh /tmp/logs/'"
}

next_steps = <<EOT

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ‚úÖ TERRAFORM DEPLOYMENT COMPLETED
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã PROCHAINES √âTAPES RECOMMAND√âES:

1. V√©rifier les utilisateurs cr√©√©s:
   ssh -p 22 root@51.15.123.45 'getent group students-inf-361'

2. Tester la connexion d'un utilisateur:
   ssh -p 22 USERNAME@51.15.123.45
...
üîç Fonctionnement d√©taill√©
1. Ressources cr√©√©es
Terraform cr√©e les ressources null_resource suivantes :

upload_script : Upload le script Bash et le fichier users.txt
execute_script : Ex√©cute le script sur le serveur
fetch_logs : T√©l√©charge les logs (optionnel)
cleanup : Nettoie les fichiers temporaires (optionnel)
display_summary : Affiche un r√©sum√© local
2. Triggers et Idempotence
hcl
triggers = {
  script_hash = filemd5(var.script_path)
  users_hash  = filemd5(var.users_file_path)
}
Terraform d√©tecte les changements via hash MD5 et ne r√©ex√©cute que si n√©cessaire.

3. Gestion de l'√©tat
bash
# Voir l'√©tat
cat terraform.tfstate

# Inspecter une ressource
terraform state show null_resource.execute_script

# Lister toutes les ressources
terraform state list
üêõ D√©pannage
Erreur: "Connection timeout"
bash
# V√©rifier la connexion SSH manuellement
ssh -v -p 22 -i ~/.ssh/id_rsa root@51.15.123.45

# Augmenter le timeout dans variables.tf
connection_timeout = 15
Erreur: "File not found"
bash
# V√©rifier les chemins relatifs
ls -lh ../partie-1-bash/create_users.sh
ls -lh ../users.txt

# Utiliser des chemins absolus si n√©cessaire
script_path = "/home/user/projet/partie-1-bash/create_users.sh"
Erreur: "Permission denied"
bash
# V√©rifier les permissions de la cl√© SSH
chmod 600 ~/.ssh/id_rsa

# V√©rifier l'utilisateur SSH
ssh -p 22 root@51.15.123.45 'whoami'
Erreur: "Script execution failed"
bash
# Se connecter au serveur pour debug
ssh -p 22 root@51.15.123.45

# V√©rifier les logs
cat /tmp/logs/user_creation_*.log

# Ex√©cuter le script manuellement
cd /tmp
sudo bash create_users.sh students-inf-361 users.txt
√âtat Terraform corrompu
bash
# Sauvegarder l'√©tat actuel
cp terraform.tfstate terraform.tfstate.backup

# Supprimer et r√©initialiser
rm -rf .terraform terraform.tfstate*
terraform init
üîê Bonnes pratiques de s√©curit√©
1. Gestion des secrets
bash
# NE JAMAIS commiter terraform.tfvars
echo "terraform.tfvars" >> .gitignore
echo "terraform.tfstate*" >> .gitignore
echo ".terraform/" >> .gitignore
2. Protection de l'√©tat
bash
# Utiliser un backend distant (S3, Terraform Cloud, etc.)
# terraform {
#   backend "s3" {
#     bucket = "my-terraform-state"
#     key    = "inf361/terraform.tfstate"
#     region = "eu-west-1"
#   }
# }
3. Variables sensibles
hcl
# Dans variables.tf
variable "ssh_private_key_content" {
  description = "Contenu de la cl√© priv√©e SSH"
  type        = string
  sensitive   = true
}

# Dans outputs.tf
output "ssh_connection_string" {
  value     = "..."
  sensitive = true
}
üìù Workflow recommand√©
D√©veloppement
bash
# 1. Modifier le code
nano main.tf

# 2. Formater
terraform fmt

# 3. Valider
terraform validate

# 4. Planifier
terraform plan

# 5. Appliquer en dev
terraform apply -var="environment=dev"
Production
bash
# 1. Test complet en staging
terraform apply -var="environment=staging"

# 2. V√©rifier les r√©sultats
ssh user@staging-server 'getent group students-inf-361'

# 3. D√©ployer en production
terraform apply -var="environment=prod"

# 4. Sauvegarder l'√©tat
cp terraform.tfstate terraform.tfstate.prod.backup
üí° Am√©liorations possibles
1. Modules Terraform
hcl
# modules/user_management/main.tf
module "user_management" {
  source = "./modules/user_management"
  
  server_ip   = var.server_ip
  group_name  = var.group_name
  users_file  = var.users_file_path
}
2. Backend distant
hcl
terraform {
  backend "s3" {
    bucket = "my-terraform-state"
    key    = "inf361/terraform.tfstate"
    region = "eu-west-1"
  }
}
3. Workspaces
bash
# Cr√©er des environnements s√©par√©s
terraform workspace new dev
terraform workspace new staging
terraform workspace new prod

# S√©lectionner un workspace
terraform workspace select dev

# Lister les workspaces
terraform workspace list
4. Provisioning cloud
hcl
# Cr√©er une VM et y ex√©cuter le script
resource "aws_instance" "vps" {
  ami           = "ami-xxxxx"
  instance_type = "t2.micro"
  
  provisioner "remote-exec" {
    inline = [
      "sudo bash /tmp/create_users.sh students-inf-361 /tmp/users.txt"
    ]
  }
}
üîÑ Int√©gration CI/CD
GitLab CI
yaml
# .gitlab-ci.yml
terraform:
  image: hashicorp/terraform:latest
  script:
    - terraform init
    - terraform validate
    - terraform plan
    - terraform apply -auto-approve
  only:
    - main
GitHub Actions
yaml
# .github/workflows/terraform.yml
name: Terraform
on: [push]
jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v2
      - run: terraform init
      - run: terraform plan
      - run: terraform apply -auto-approve
üìö R√©f√©rences
Terraform Documentation
Terraform Best Practices
Provisioners Documentation
Null Provider
‚úÖ Checklist de tests
 Terraform install√© et fonctionnel
 Variables configur√©es dans terraform.tfvars
 Connexion SSH au serveur test√©e
 Script Bash fonctionnel (Partie 1)
 terraform init r√©ussi
 terraform validate r√©ussi
 terraform plan affiche les bonnes ressources
 terraform apply ex√©cut√© avec succ√®s
 Utilisateurs cr√©√©s sur le serveur
 Logs t√©l√©charg√©s localement
 Outputs affich√©s correctement
 √âtat Terraform propre
 Fichiers sensibles non commit√©s
üë§ Auteur
√âtudiant Licence 3 Informatique - Universit√© de Yaound√© I
Cours: INF 3611 - Administration Syst√®mes et R√©seaux

