Partie 0 : Configuration et durcissement du serveur SSH
ğŸ“‹ Description
Guide complet pour configurer et sÃ©curiser le service SSH avant la crÃ©ation d'utilisateurs. Cette partie est CRITIQUE car une mauvaise configuration peut vous bloquer l'accÃ¨s Ã  votre serveur.

âš ï¸ AVERTISSEMENT IMPORTANT
UNE ERREUR DANS LA CONFIGURATION SSH PEUT VOUS FAIRE PERDRE L'ACCÃˆS Ã€ VOTRE SERVEUR !

Suivez STRICTEMENT la procÃ©dure dÃ©crite ci-dessous pour Ã©viter de vous retrouver bloquÃ©.

ğŸ” ProcÃ©dure correcte de modification
Ã‰tape 1 : Sauvegarde
bash
# CrÃ©er une sauvegarde horodatÃ©e
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)

# VÃ©rifier la sauvegarde
ls -lh /etc/ssh/sshd_config*
Ã‰tape 2 : Modification
bash
# Ã‰diter le fichier de configuration
sudo nano /etc/ssh/sshd_config

# OU avec vim
sudo vim /etc/ssh/sshd_config
Ã‰tape 3 : Test de syntaxe
bash
# TOUJOURS tester la configuration avant de l'appliquer
sudo sshd -t

# Si OK, vous verrez rien (silence = succÃ¨s)
# Si erreur, vous verrez le message d'erreur Ã  corriger
Ã‰tape 4 : Rechargement (PAS redÃ©marrage)
bash
# Utiliser reload, PAS restart
sudo systemctl reload sshd

# VÃ©rifier le statut
sudo systemctl status sshd
Ã‰tape 5 : Test avec NOUVELLE session
CRITIQUE : Ne JAMAIS fermer votre session actuelle avant de tester !

bash
# Dans un NOUVEAU terminal/onglet, tester la connexion
ssh -p NOUVEAU_PORT user@serveur

# OU depuis une autre machine
ssh -p NOUVEAU_PORT user@IP_SERVEUR
Ã‰tape 6 : Validation finale
bash
# Une fois la nouvelle connexion Ã©tablie, vous pouvez fermer l'ancienne
# Si la connexion Ã©choue, retournez Ã  l'ancienne session et corrigez
âš ï¸ Risque principal encouru
Qu'est-ce qui peut mal tourner ?
Si vous redÃ©marrez le service SSH (systemctl restart sshd) avec une configuration incorrecte :

Le service SSH s'arrÃªte
Il ne redÃ©marre pas (erreur de config)
Toutes les connexions SSH sont coupÃ©es
Impossible de se reconnecter
AccÃ¨s au serveur perdu
ConsÃ©quences
Perte totale d'accÃ¨s SSH au serveur
NÃ©cessitÃ© d'accÃ¨s physique ou console de rÃ©cupÃ©ration
Temps d'arrÃªt prolongÃ©
Perte potentielle de donnÃ©es si pas de backup
Solution si vous Ãªtes bloquÃ©
bash
# Si vous avez accÃ¨s Ã  la console web du VPS
# 1. Se connecter via console
# 2. Restaurer la sauvegarde
sudo cp /etc/ssh/sshd_config.backup /etc/ssh/sshd_config
sudo systemctl restart sshd

# Si impossible, rÃ©installer SSH
sudo apt install --reinstall openssh-server
ğŸ›¡ï¸ ParamÃ¨tres de sÃ©curitÃ© recommandÃ©s
1. Changer le port SSH par dÃ©faut
Justification : Le port 22 est la cible privilÃ©giÃ©e des attaques automatisÃ©es. En changeant le port, vous rÃ©duisez considÃ©rablement les tentatives d'intrusion par des bots.

bash
# Avant (dans /etc/ssh/sshd_config)
#Port 22

# AprÃ¨s
Port 2222
Impact :

âœ… RÃ©duit les attaques automatisÃ©es de ~99%
âœ… Logs d'intrusion beaucoup moins nombreux
âš ï¸ NÃ©cessite de spÃ©cifier le port Ã  chaque connexion : ssh -p 2222 user@server
2. DÃ©sactiver la connexion root directe
Justification : L'utilisateur root a tous les privilÃ¨ges. Forcer l'utilisation de comptes utilisateurs avec sudo amÃ©liore la traÃ§abilitÃ© et la sÃ©curitÃ©. En cas de compromission d'un mot de passe, l'attaquant n'a pas immÃ©diatement les droits root.

bash
# Configuration
PermitRootLogin no
Impact :

âœ… Force l'utilisation de comptes utilisateurs
âœ… Meilleure traÃ§abilitÃ© des actions administratives
âœ… Authentification en deux Ã©tapes (compte + sudo)
âš ï¸ NÃ©cessite de crÃ©er un compte utilisateur avec droits sudo AVANT d'appliquer
ProcÃ©dure sÃ©curisÃ©e :

bash
# 1. CrÃ©er un utilisateur admin AVANT de dÃ©sactiver root
sudo adduser admin
sudo usermod -aG sudo admin

# 2. Tester la connexion avec le nouveau compte
ssh admin@serveur
sudo ls /root  # Tester sudo

# 3. Une fois confirmÃ©, dÃ©sactiver root dans sshd_config
3. Authentification par clÃ©s uniquement
Justification : Les mots de passe peuvent Ãªtre devinÃ©s par force brute. Les clÃ©s SSH (2048+ bits) sont pratiquement impossibles Ã  casser. L'authentification par clÃ©s Ã©limine complÃ¨tement les attaques par force brute sur les mots de passe.

bash
# Configuration
PasswordAuthentication no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
Impact :

âœ… Ã‰limine 100% des attaques par force brute
âœ… Authentification beaucoup plus forte
âœ… Pas besoin de mÃ©moriser de mots de passe
âš ï¸ NÃ©cessite de configurer les clÃ©s SSH AVANT d'appliquer
ProcÃ©dure sÃ©curisÃ©e :

bash
# 1. GÃ©nÃ©rer une paire de clÃ©s SSH (sur votre machine locale)
ssh-keygen -t ed25519 -C "votre-email@example.com"
# OU pour RSA
ssh-keygen -t rsa -b 4096 -C "votre-email@example.com"

# 2. Copier la clÃ© publique sur le serveur
ssh-copy-id -p PORT user@serveur

# 3. Tester la connexion par clÃ©s
ssh -p PORT user@serveur
# Vous ne devriez PAS avoir Ã  entrer de mot de passe

# 4. Une fois confirmÃ©, dÃ©sactiver l'authentification par mot de passe
sudo nano /etc/ssh/sshd_config
# PasswordAuthentication no
4. Limiter les tentatives d'authentification
Justification : Limite le nombre de tentatives de connexion, rendant les attaques par force brute encore plus difficiles. RÃ©duit Ã©galement la charge CPU lors d'attaques massives.

bash
# Configuration
MaxAuthTries 3
MaxSessions 2
MaxStartups 3:50:10
Signification :

MaxAuthTries 3 : Maximum 3 tentatives de mot de passe/clÃ© par connexion
MaxSessions 2 : Maximum 2 sessions SSH simultanÃ©es par connexion
MaxStartups 3:50:10 : Gestion des connexions simultanÃ©es (3 non authentifiÃ©es, puis probabilitÃ© de refus jusqu'Ã  10)
Impact :

âœ… Ralentit considÃ©rablement les attaques par force brute
âœ… ProtÃ¨ge contre les attaques de dÃ©ni de service (DoS)
âœ… RÃ©duit la charge serveur lors d'attaques
5. DÃ©sactiver les protocoles et fonctionnalitÃ©s faibles
Justification : SSH version 1 a des vulnÃ©rabilitÃ©s connues. Les mots de passe vides sont une faille de sÃ©curitÃ© Ã©vidente. Le X11 forwarding peut Ãªtre exploitÃ© s'il n'est pas nÃ©cessaire.

bash
# Configuration
Protocol 2
PermitEmptyPasswords no
X11Forwarding no
PermitUserEnvironment no
Impact :

âœ… Utilise uniquement SSH v2 (plus sÃ©curisÃ©)
âœ… EmpÃªche les comptes sans mot de passe
âœ… DÃ©sactive les fonctionnalitÃ©s inutilisÃ©es (rÃ©duction de la surface d'attaque)
â„¹ï¸ Mettre X11Forwarding yes si vous avez besoin d'applications graphiques distantes
6. Timeouts et dÃ©connexions automatiques
Justification : Les sessions inactives sont des points d'entrÃ©e potentiels si quelqu'un s'Ã©loigne de sa machine sans se dÃ©connecter. Les timeouts forcent la dÃ©connexion automatique.

bash
# Configuration
ClientAliveInterval 300
ClientAliveCountMax 2
LoginGraceTime 60
TCPKeepAlive yes
Signification :

ClientAliveInterval 300 : Envoie un message "keep-alive" toutes les 5 minutes
ClientAliveCountMax 2 : AprÃ¨s 2 messages sans rÃ©ponse, dÃ©connecte (10 minutes d'inactivitÃ©)
LoginGraceTime 60 : Temps maximum pour s'authentifier : 60 secondes
TCPKeepAlive yes : Maintient la connexion TCP active
Impact :

âœ… DÃ©connexion automatique aprÃ¨s 10 minutes d'inactivitÃ©
âœ… Protection contre les sessions abandonnÃ©es
âœ… LibÃ¨re les ressources serveur
7. Limiter les utilisateurs/groupes autorisÃ©s
Justification : ContrÃ´le prÃ©cis de qui peut se connecter via SSH. ImplÃ©mente le principe du moindre privilÃ¨ge (least privilege).

bash
# Configuration - Choisir UNE des options

# Option 1: Autoriser uniquement certains utilisateurs
AllowUsers alice bob charlie admin

# Option 2: Autoriser uniquement certains groupes
AllowGroups students-inf-361 admins

# Option 3: Combiner (recommandÃ©)
AllowUsers admin
AllowGroups students-inf-361

# Option 4: Bloquer certains utilisateurs (moins recommandÃ©)
DenyUsers guest test
Impact :

âœ… ContrÃ´le granulaire des accÃ¨s SSH
âœ… Facile Ã  maintenir via la gestion de groupes
âœ… EmpÃªche les comptes systÃ¨me de se connecter
8. ParamÃ¨tres de chiffrement renforcÃ©s
Justification : Utiliser les algorithmes de chiffrement les plus modernes et sÃ©curisÃ©s. DÃ©sactiver les anciens algorithmes faibles.

bash
# Configuration avancÃ©e
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
HostKeyAlgorithms ssh-ed25519,ssh-rsa
Impact :

âœ… Utilise uniquement les algorithmes modernes et sÃ©curisÃ©s
âœ… Protection contre les attaques cryptographiques connues
âš ï¸ Peut causer des problÃ¨mes de compatibilitÃ© avec de trÃ¨s vieux clients SSH
9. BanniÃ¨re et logging
Justification : Avertissement lÃ©gal et traÃ§abilitÃ© complÃ¨te des connexions.

bash
# Configuration
Banner /etc/ssh/banner
LogLevel VERBOSE
SyslogFacility AUTH
CrÃ©er la banniÃ¨re :

bash
sudo nano /etc/ssh/banner
Contenu suggÃ©rÃ© :

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ACCÃˆS AUTORISÃ‰ UNIQUEMENT                    â•‘
â•‘                                                                â•‘
â•‘  Ceci est un systÃ¨me privÃ©. L'accÃ¨s non autorisÃ© est interdit â•‘
â•‘  et sera poursuivi conformÃ©ment Ã  la loi. Toutes les actions  â•‘
â•‘  sont enregistrÃ©es et surveillÃ©es.                             â•‘
â•‘                                                                â•‘
â•‘  UniversitÃ© de YaoundÃ© I - DÃ©partement d'Informatique          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Impact :

âœ… Avertissement lÃ©gal affichÃ© avant connexion
âœ… Logs dÃ©taillÃ©s de toutes les tentatives de connexion
âœ… Aide Ã  l'investigation en cas d'incident
ğŸ“ Configuration complÃ¨te recommandÃ©e
Voici un fichier /etc/ssh/sshd_config complet et sÃ©curisÃ© :

bash
# ============================================================================
# Configuration SSH sÃ©curisÃ©e - INF 3611
# UniversitÃ© de YaoundÃ© I - DÃ©partement d'Informatique
# ============================================================================

# ParamÃ¨tres de base
Port 2222
Protocol 2
AddressFamily inet
ListenAddress 0.0.0.0

# Authentification
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
ChallengeResponseAuthentication no
PermitEmptyPasswords no
UsePAM yes

# Limitations
MaxAuthTries 3
MaxSessions 2
MaxStartups 3:50:10
LoginGraceTime 60

# ContrÃ´le d'accÃ¨s
AllowGroups students-inf-361 sudo
# AllowUsers admin alice bob

# Timeouts
ClientAliveInterval 300
ClientAliveCountMax 2
TCPKeepAlive yes

# FonctionnalitÃ©s
X11Forwarding no
PrintMotd no
PrintLastLog yes
PermitUserEnvironment no
PermitTunnel no
AllowTcpForwarding no
AllowStreamLocalForwarding no
GatewayPorts no

# Chiffrement (moderne)
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org
HostKeyAlgorithms ssh-ed25519,ssh-rsa

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# BanniÃ¨re
Banner /etc/ssh/banner

# Subsystem SFTP
Subsystem sftp /usr/lib/openssh/sftp-server
ğŸ”§ Application de la configuration
Script d'application sÃ©curisÃ©e
bash
#!/bin/bash
# apply_ssh_config.sh

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "   Application sÃ©curisÃ©e de la configuration SSH"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# 1. Sauvegarde
echo "ğŸ“ CrÃ©ation de la sauvegarde..."
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)

# 2. Modification (dÃ©commenter aprÃ¨s avoir prÃ©parÃ© votre config)
# echo "âœï¸  Application de la nouvelle configuration..."
# sudo cp sshd_config.secure /etc/ssh/sshd_config

# 3. Test de syntaxe
echo "ğŸ” Test de la syntaxe..."
if sudo sshd -t; then
    echo "âœ… Configuration valide"
else
    echo "âŒ Erreur de configuration! Restauration de la sauvegarde..."
    sudo cp /etc/ssh/sshd_config.backup.* /etc/ssh/sshd_config
    exit 1
fi

# 4. Reload
echo "ğŸ”„ Rechargement du service..."
sudo systemctl reload sshd

# 5. VÃ©rification
echo "âœ“ VÃ©rification du statut..."
sudo systemctl status sshd --no-pager

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âš ï¸  IMPORTANT: Testez la connexion dans un NOUVEAU"
echo "   terminal AVANT de fermer cette session!"
echo ""
echo "   ssh -p 2222 user@$(hostname -I | awk '{print $1}')"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
ğŸ” VÃ©rification et tests
VÃ©rifier la configuration actuelle
bash
# Afficher la config active (sans commentaires)
sudo grep -v '^#' /etc/ssh/sshd_config | grep -v '^$'

# Tester la syntaxe
sudo sshd -t -f /etc/ssh/sshd_config

# VÃ©rifier le port d'Ã©coute
sudo netstat -tlnp | grep sshd
# OU
sudo ss -tlnp | grep sshd
Tests de connexion
bash
# Test depuis localhost
ssh -p 2222 localhost

# Test avec verbositÃ© (debug)
ssh -vvv -p 2222 user@serveur

# Tester l'authentification par clÃ©s
ssh -i ~/.ssh/id_rsa -p 2222 user@serveur

# Tester depuis une autre machine
ssh -p 2222 user@IP_PUBLIQUE
VÃ©rifier les logs
bash
# Logs SSH en temps rÃ©el
sudo tail -f /var/log/auth.log

# Filtrer les tentatives de connexion
sudo grep sshd /var/log/auth.log | tail -20

# Voir les Ã©checs d'authentification
sudo grep "Failed password" /var/log/auth.log

# Voir les connexions rÃ©ussies
sudo grep "Accepted" /var/log/auth.log
ğŸ›¡ï¸ Protection supplÃ©mentaire avec Fail2ban
bash
# Installer Fail2ban
sudo apt install fail2ban

# Configurer pour SSH
sudo nano /etc/fail2ban/jail.local
ini
[sshd]
enabled = true
port = 2222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
bash
# RedÃ©marrer Fail2ban
sudo systemctl restart fail2ban

# VÃ©rifier le statut
sudo fail2ban-client status sshd
ğŸ“š RÃ©fÃ©rences
OpenSSH Documentation
SSH Best Practices
CIS Benchmarks for SSH
âœ… Checklist de sÃ©curitÃ©
 Sauvegarde de la configuration crÃ©Ã©e
 Port SSH changÃ© (diffÃ©rent de 22)
 PermitRootLogin dÃ©sactivÃ©
 Authentification par clÃ©s configurÃ©e
 PasswordAuthentication dÃ©sactivÃ© (aprÃ¨s config clÃ©s)
 MaxAuthTries limitÃ© Ã  3
 Timeouts configurÃ©s
 AllowGroups ou AllowUsers configurÃ©
 BanniÃ¨re crÃ©Ã©e et activÃ©e
 LogLevel dÃ©fini sur VERBOSE
 Configuration testÃ©e avec sshd -t
 Service rechargÃ© (reload, pas restart)
 Nouvelle connexion testÃ©e avant fermeture
 Fail2ban installÃ© et configurÃ©
 Documentation crÃ©Ã©e pour l'Ã©quipe
ğŸ‘¤ Auteur
Ã‰tudiant Licence 3 Informatique - UniversitÃ© de YaoundÃ© I
Cours: INF 3611 - Administration SystÃ¨mes et RÃ©seaux

