Partie 2 : Playbook Ansible
üìã Description
Playbook Ansible complet qui reproduit toutes les fonctionnalit√©s du script Bash avec en plus l'envoi automatique d'emails personnalis√©s √† chaque utilisateur cr√©√©.

üéØ Fonctionnalit√©s
‚úÖ Toutes les fonctionnalit√©s de la Partie 1
Cr√©ation du groupe students-inf-361
Cr√©ation d'utilisateurs avec m√©tadonn√©es compl√®tes
V√©rification et installation de shells
Hachage SHA-512 des mots de passe
Changement de mot de passe obligatoire
Acc√®s sudo avec restriction de su
Messages de bienvenue personnalis√©s
Quotas disque (15 Go)
Limites m√©moire (20% RAM)
‚ûï Fonctionnalit√©s suppl√©mentaires
Envoi d'email automatique avec :
Adresse IP du serveur
Port SSH
Nom d'utilisateur
Mot de passe initial
Commande SSH de connexion
Commandes pour transf√©rer la cl√© publique (Linux/Mac/Windows)
Orchestration multi-serveurs
Idempotence garantie
Gestion d'erreurs avanc√©e
üì¶ Structure des fichiers
partie-2-ansible/
‚îú‚îÄ‚îÄ README.md                 # Ce fichier
‚îú‚îÄ‚îÄ create_users.yml          # Playbook principal
‚îú‚îÄ‚îÄ inventory.ini             # Inventaire des serveurs
‚îú‚îÄ‚îÄ ansible.cfg              # Configuration Ansible (optionnel)
‚îî‚îÄ‚îÄ templates/               # Templates (optionnel)
    ‚îî‚îÄ‚îÄ welcome_email.j2
üîß Pr√©requis
Sur la machine de contr√¥le (votre PC)
bash
# Installer Ansible
sudo apt update
sudo apt install -y ansible

# V√©rifier l'installation
ansible --version

# Installer les collections n√©cessaires (si besoin)
ansible-galaxy collection install ansible.posix
ansible-galaxy collection install community.general
Sur le serveur cible
bash
# Python 3 doit √™tre install√©
sudo apt install -y python3 python3-pip

# Configurer l'acc√®s SSH par cl√©s
ssh-copy-id -p PORT user@SERVER_IP
‚öôÔ∏è Configuration
1. Configurer l'inventaire
√âditer inventory.ini :

ini
[vps_servers]
vps1 ansible_host=51.15.123.45

[vps_servers:vars]
ansible_user=root
ansible_ssh_private_key_file=~/.ssh/id_rsa
ansible_python_interpreter=/usr/bin/python3
Remplacer :

51.15.123.45 par l'IP de votre serveur
ansible_user=root si vous utilisez un autre utilisateur
Ajouter ansible_port=2222 si SSH n'est pas sur le port 22
2. Configurer l'envoi d'emails
√âditer create_users.yml et modifier les variables :

yaml
vars:
  smtp_host: "smtp.gmail.com"
  smtp_port: 587
  smtp_username: "votre-email@gmail.com"
  smtp_password: "votre-mot-de-passe-app"
  email_from: "admin@uy1.cm"
  ssh_port: 22  # Port SSH de votre serveur
Configuration Gmail (recommand√©)
Activer l'authentification √† 2 facteurs sur votre compte Gmail
G√©n√©rer un mot de passe d'application :
Aller sur https://myaccount.google.com/security
Chercher "Mots de passe des applications"
G√©n√©rer un nouveau mot de passe pour "Autre (nom personnalis√©)"
Utiliser ce mot de passe dans smtp_password
Autres fournisseurs SMTP
yaml
# Outlook/Hotmail
smtp_host: "smtp-mail.outlook.com"
smtp_port: 587

# Yahoo
smtp_host: "smtp.mail.yahoo.com"
smtp_port: 587

# Serveur SMTP personnalis√©
smtp_host: "mail.votre-domaine.com"
smtp_port: 587  # ou 465 pour SSL
3. Tester la connexion
bash
# Tester la connectivit√©
ansible -i inventory.ini vps_servers -m ping

# V√©rifier les facts du serveur
ansible -i inventory.ini vps_servers -m setup

# Tester une commande simple
ansible -i inventory.ini vps_servers -m command -a "uptime"
üöÄ Utilisation
1. Ex√©cution du playbook
bash
# Ex√©cution standard
ansible-playbook -i inventory.ini create_users.yml

# Avec verbosit√© (pour debug)
ansible-playbook -i inventory.ini create_users.yml -v
ansible-playbook -i inventory.ini create_users.yml -vv
ansible-playbook -i inventory.ini create_users.yml -vvv

# Dry-run (simulation sans modification)
ansible-playbook -i inventory.ini create_users.yml --check

# Ex√©cuter uniquement certaines t√¢ches (tags)
ansible-playbook -i inventory.ini create_users.yml --tags "users"
2. Surcharger des variables
bash
# Changer le fichier utilisateurs
ansible-playbook -i inventory.ini create_users.yml -e "users_file=../other_users.txt"

# Changer le nom du groupe
ansible-playbook -i inventory.ini create_users.yml -e "group_name=my-custom-group"

# Changer le quota disque
ansible-playbook -i inventory.ini create_users.yml -e "disk_quota_gb=20"

# D√©sactiver l'envoi d'emails (en commentant le task)
ansible-playbook -i inventory.ini create_users.yml --skip-tags "email"
3. Ex√©cution sur plusieurs serveurs
ini
# inventory.ini
[vps_servers]
vps1 ansible_host=192.168.1.100
vps2 ansible_host=192.168.1.101
vps3 ansible_host=192.168.1.102
bash
# Ex√©cuter sur tous les serveurs
ansible-playbook -i inventory.ini create_users.yml

# Limiter √† un serveur sp√©cifique
ansible-playbook -i inventory.ini create_users.yml --limit vps1
üìß Format de l'email envoy√©
Chaque utilisateur re√ßoit un email contenant :

Sujet: Votre compte VPS a √©t√© cr√©√© - Cours INF 3611

Bonjour Alice Kamga,

Votre compte utilisateur a √©t√© cr√©√© avec succ√®s sur le serveur VPS du cours INF 3611.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã INFORMATIONS DE CONNEXION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üñ•Ô∏è  Adresse IP du serveur : 51.15.123.45
üîå Port SSH              : 22
üë§ Nom d'utilisateur     : alice
üîê Mot de passe initial  : P@ssw0rd123

‚ö†Ô∏è  IMPORTANT : Vous DEVEZ changer ce mot de passe lors de votre premi√®re connexion.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîß COMMANDES UTILES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üì° Commande de connexion SSH :

   ssh -p 22 alice@51.15.123.45

üîë Transf√©rer votre cl√© publique SSH (recommand√©) :

   - Depuis Linux/Mac :
     ssh-copy-id -p 22 alice@51.15.123.45

   - Depuis Windows (PowerShell) :
     type $env:USERPROFILE\.ssh\id_rsa.pub | ssh -p 22 alice@51.15.123.45 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

   - Alternative multiplateforme :
     cat ~/.ssh/id_rsa.pub | ssh -p 22 alice@51.15.123.45 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"

...
üîç V√©rification
Tester les cr√©ations
bash
# V√©rifier les utilisateurs sur le serveur
ansible -i inventory.ini vps_servers -m command -a "getent group students-inf-361"

# V√©rifier un utilisateur sp√©cifique
ansible -i inventory.ini vps_servers -m command -a "id alice"

# V√©rifier les quotas
ansible -i inventory.ini vps_servers -m command -a "quota -u alice" -b
Consulter les logs Ansible
bash
# Voir les logs de la derni√®re ex√©cution
cat /var/log/ansible.log

# Logs en temps r√©el
tail -f /var/log/ansible.log
üìä Sortie attendue
PLAY [Cr√©ation automatis√©e d'utilisateurs Linux avec envoi d'emails] ***********

TASK [Gathering Facts] **********************************************************
ok: [vps1]

TASK [0.1 - Afficher un message de d√©but] **************************************
ok: [vps1] => {
    "msg": "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë      ANSIBLE - CR√âATION AUTOMATIS√âE D'UTILISATEURS            ‚ïë\n‚ïë                 UNIVERSIT√â DE YAOUND√â I                        ‚ïë\n‚ïë          INF 3611 - Administration Syst√®mes et R√©seaux         ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n"
}

TASK [0.2 - Installer les d√©pendances syst√®me] *********************************
changed: [vps1]

...

TASK [5.1 - Cr√©er les utilisateurs] *********************************************
changed: [vps1] => (item={'username': 'alice', ...})
changed: [vps1] => (item={'username': 'bob', ...})

...

TASK [9.2 - Envoyer un email personnalis√© √† chaque utilisateur] ****************
ok: [vps1] => (item={'username': 'alice', ...})
ok: [vps1] => (item={'username': 'bob', ...})

TASK [10.1 - Afficher le r√©sum√© final] ******************************************
ok: [vps1] => {
    "msg": "‚úÖ CR√âATION D'UTILISATEURS TERMIN√âE AVEC SUCC√àS\n..."
}

PLAY RECAP **********************************************************************
vps1                       : ok=25   changed=8    unreachable=0    failed=0
‚ö†Ô∏è Gestion des erreurs
Probl√®me de connexion SSH
bash
# V√©rifier la connexion SSH manuelle
ssh -p PORT user@IP

# D√©sactiver la v√©rification des cl√©s d'h√¥te (dev uniquement)
export ANSIBLE_HOST_KEY_CHECKING=False
ansible-playbook -i inventory.ini create_users.yml
Probl√®me d'envoi d'email
yaml
# Option 1: Ignorer les erreurs d'email (d√©j√† dans le playbook)
ignore_errors: yes

# Option 2: D√©sactiver compl√®tement l'envoi d'emails
# Commenter le task 9.2 dans create_users.yml
Probl√®me de permissions
bash
# S'assurer que l'utilisateur peut utiliser sudo
ansible-playbook -i inventory.ini create_users.yml --become --ask-become-pass

# Ou configurer sudoers sur le serveur
echo "ansible_user ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ansible_user
Probl√®me de quotas
Les quotas n√©cessitent une configuration sp√©cifique de la partition :

bash
# Se connecter au serveur
ssh user@server

# √âditer /etc/fstab
sudo nano /etc/fstab

# Ajouter usrquota,grpquota aux options
# Avant: UUID=xxx /home ext4 defaults 0 2
# Apr√®s:  UUID=xxx /home ext4 defaults,usrquota,grpquota 0 2

# Remonter et initialiser
sudo mount -o remount /home
sudo quotacheck -cugm /home
sudo quotaon /home
üîê Bonnes pratiques de s√©curit√©
1. Protection des identifiants SMTP
Ne jamais commiter les mots de passe dans Git !

bash
# Cr√©er un fichier de variables s√©curis√©
echo "smtp_password: votre_mot_de_passe" > secrets.yml

# Chiffrer avec Ansible Vault
ansible-vault encrypt secrets.yml

# Utiliser dans le playbook
ansible-playbook -i inventory.ini create_users.yml --extra-vars "@secrets.yml" --ask-vault-pass
2. Variables d'environnement
bash
# D√©finir les variables sensibles
export SMTP_PASSWORD="votre_mot_de_passe"

# Utiliser dans le playbook
ansible-playbook -i inventory.ini create_users.yml -e "smtp_password=${SMTP_PASSWORD}"
3. Fichier ansible.cfg
Cr√©er ansible.cfg :

ini
[defaults]
inventory = inventory.ini
remote_user = root
host_key_checking = False
retry_files_enabled = False
log_path = ./ansible.log

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
üí° Am√©liorations possibles
Templates Jinja2 : Externaliser les templates d'email
Roles Ansible : Organiser en r√¥les r√©utilisables
Handlers : G√©rer les red√©marrages de services
Dynamic Inventory : Int√©gration avec cloud providers
Tests : Ajouter des assertions et validations
Notifications : Slack, Discord, etc.
üìö R√©f√©rences
Ansible Documentation
Ansible User Module
Ansible Mail Module
Ansible Best Practices
‚úÖ Checklist de tests
 Connexion Ansible fonctionnelle
 Playbook s'ex√©cute sans erreur
 Utilisateurs cr√©√©s correctement
 Groupe cr√©√©
 Restrictions sudo actives
 Messages de bienvenue configur√©s
 Quotas configur√©s
 Limites m√©moire actives
 Emails re√ßus par tous les utilisateurs
 Commandes SSH dans emails correctes
 Idempotence (r√©ex√©cution = pas de changement)
üë§ Auteur
√âtudiant Licence 3 Informatique - Universit√© de Yaound√© I
Cours: INF 3611 - Administration Syst√®mes et R√©seaux

